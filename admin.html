<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معهد القرآن الكريم - لوحة التحكم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c786c;
            --secondary-color: #004445;
            --accent-color: #f8b400;
            --light-color: #faf5e4;
            --dark-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
            direction: rtl;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header & Logo */
        .admin-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2rem;
            color: var(--light-color);
        }

        .logo h1 {
            margin: 0;
            font-size: 1.8rem;
            color: white;
        }

        .admin-nav {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .admin-nav a:hover, .admin-nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Sections */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-card h4 {
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--light-color);
            color: var(--secondary-color);
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(44, 120, 108, 0.05);
        }

        /* Score Badges */
        .score-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .excellent {
            background-color: var(--success-color);
        }

        .very-good {
            background-color: #5cb85c;
        }

        .good {
            background-color: var(--info-color);
        }

        .weak {
            background-color: var(--danger-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            color: var(--dark-color);
            position: relative;
            font-weight: 500;
        }

        .tab-btn.active {
            color: var(--primary-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-nav {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .admin-nav a {
                white-space: nowrap;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h1>لوحة تحكم المعهد</h1>
            </div>
            <nav class="admin-nav">
                <a href="#" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
                <a href="#" data-section="students"><i class="fas fa-users"></i> الطلاب</a>
                <a href="#" data-section="tests"><i class="fas fa-clipboard-check"></i> الاختبارات</a>
                <a href="#" data-section="reports"><i class="fas fa-chart-bar"></i> التقارير</a>
                <a href="#" class="logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
            </nav>
        </header>
        
        <!-- قسم لوحة التحكم -->
        <section id="dashboard" class="admin-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <h4>عدد الطلاب</h4>
                    <p id="totalStudents">0</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-graduation-cap"></i>
                    <h4>طلاب المستوى المتقدم</h4>
                    <p id="advancedStudents">0</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-quran"></i>
                    <h4>اختبارات هذا الشهر</h4>
                    <p id="monthlyTests">0</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-percentage"></i>
                    <h4>متوسط التقدم</h4>
                    <p id="avgProgress">0%</p>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-bell"></i> الإشعارات الحديثة</h3>
                <div id="recentNotifications">
                    <p>لا توجد إشعارات حديثة</p>
                </div>
            </div>

            <div class="card">
                <button id="saveToGitHub" class="btn btn-primary">
                    <i class="fas fa-save"></i> حفظ التغييرات على GitHub
                </button>
                <p id="saveStatus" style="margin-top: 10px;"></p>
            </div>
        </section>
        
        <!-- قسم إدارة الطلاب -->
        <section id="students" class="admin-section">
            <div class="card">
                <h3><i class="fas fa-user-plus"></i> إضافة طالب جديد</h3>
                <form id="addStudentForm">
                    <div class="form-group">
                        <label for="studentName">اسم الطالب</label>
                        <input type="text" id="studentName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="studentId">رقم الطالب السري</label>
                        <input type="text" id="studentId" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="studentLevel">المستوى</label>
                        <select id="studentLevel" class="form-control" required>
                            <option value="مبتدئ">مبتدئ</option>
                            <option value="متوسط">متوسط</option>
                            <option value="متقدم">متقدم</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentImage">رابط الصورة</label>
                        <input type="text" id="studentImage" class="form-control" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ</button>
                </form>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-users"></i> قائمة الطلاب</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الصورة</th>
                                <th>اسم الطالب</th>
                                <th>رقم الطالب</th>
                                <th>المستوى</th>
                                <th>التقدم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList">
                            <!-- سيتم ملؤها بالبيانات عبر الجافاسكربت -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- قسم إدارة الاختبارات -->
        <section id="tests" class="admin-section">
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> إضافة اختبار جديد</h3>
                <form id="addTestForm">
                    <div class="form-group">
                        <label for="testType">نوع الاختبار</label>
                        <select id="testType" class="form-control" required>
                            <option value="quran">اختبار حفظ القرآن</option>
                            <option value="tajweed">اختبار التجويد</option>
                            <option value="lesson">اختبار الدرس</option>
                        </select>
                    </div>
                    <div class="form-group" id="testDetailsContainer">
                        <!-- سيتم ملؤها ديناميكياً بناءً على نوع الاختبار -->
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ</button>
                </form>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-list"></i> قائمة الاختبارات</h3>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="quranTestsTab">اختبارات القرآن</button>
                    <button class="tab-btn" data-tab="tajweedTestsTab">اختبارات التجويد</button>
                    <button class="tab-btn" data-tab="lessonTestsTab">اختبارات الدروس</button>
                </div>
                
                <div class="tab-content active" id="quranTestsTab">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>الجزء</th>
                                    <th>الحفظ</th>
                                    <th>التلاوة</th>
                                    <th>التاريخ</th>
                                    <th>الطالب</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="quranTestsList">
                                <!-- سيتم ملؤها بالبيانات عبر الجافاسكربت -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="tajweedTestsTab">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>الاختبار</th>
                                    <th>النتيجة</th>
                                    <th>التقييم</th>
                                    <th>التاريخ</th>
                                    <th>الطالب</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="tajweedTestsList">
                                <!-- سيتم ملؤها بالبيانات عبر الجافاسكربت -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="lessonTestsTab">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>الدرس</th>
                                    <th>النتيجة</th>
                                    <th>التقييم</th>
                                    <th>التاريخ</th>
                                    <th>الطالب</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="lessonTestsList">
                                <!-- سيتم ملؤها بالبيانات عبر الجافاسكربت -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- قسم التقارير -->
        <section id="reports" class="admin-section">
            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> تقارير الطلاب</h3>
                <div class="form-group">
                    <label for="reportStudent">اختر الطالب</label>
                    <select id="reportStudent" class="form-control">
                        <option value="">جميع الطلاب</option>
                        <!-- سيتم ملؤها بالبيانات عبر الجافاسكربت -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportType">نوع التقرير</label>
                    <select id="reportType" class="form-control">
                        <option value="progress">تقرير التقدم</option>
                        <option value="tests">تقرير الاختبارات</option>
                        <option value="performance">تقرير الأداء</option>
                    </select>
                </div>
                <button id="generateReport" class="btn btn-primary"><i class="fas fa-file-pdf"></i> إنشاء التقرير</button>
                
                <div id="reportPreview" class="mt-4">
                    <!-- سيتم عرض معاينة التقرير هنا -->
                </div>
            </div>
        </section>
    </div>
    
    <!-- Modal for Edit Student -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> تعديل بيانات الطالب</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="editStudentForm">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label for="editStudentName">اسم الطالب</label>
                    <input type="text" id="editStudentName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editStudentLevel">المستوى</label>
                    <select id="editStudentLevel" class="form-control" required>
                        <option value="مبتدئ">مبتدئ</option>
                        <option value="متوسط">متوسط</option>
                        <option value="متقدم">متقدم</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editStudentImage">رابط الصورة</label>
                    <input type="text" id="editStudentImage" class="form-control" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="editStudentProgress">التقدم (%)</label>
                    <input type="number" id="editStudentProgress" class="form-control" min="0" max="100" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteStudentBtn">حذف الطالب</button>
                    <button type="submit" class="btn btn-primary">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Edit Test -->
    <div id="editTestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> تعديل بيانات الاختبار</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="editTestForm">
                <input type="hidden" id="editTestType">
                <input type="hidden" id="editTestId">
                <input type="hidden" id="editTestStudentId">
                <div id="editTestFields">
                    <!-- سيتم ملؤها ديناميكياً حسب نوع الاختبار -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteTestBtn">حذف الاختبار</button>
                    <button type="submit" class="btn btn-primary">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== المتغيرات العامة ==========
        let studentsData = { students: [] };
        const GITHUB_TOKEN = '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'; // أضف token GitHub الخاص بك هنا
        const GITHUB_REPO = 'jiil';  // اسم المستودع
        const GITHUB_USER = 'abo1fayz';  // اسم مستخدم GitHub
        const FILE_PATH = 'data.json'; // مسار الملف في المستودع

        // ========== تهيئة الصفحة ==========
        document.addEventListener("DOMContentLoaded", function() {
            // تحميل البيانات عند بدء التشغيل
            loadAdminData();
            
            // إعداد التنقل بين الأقسام
            setupAdminNavigation();
            
            // إعداد النماذج
            setupAdminForms();
            
            // إعداد الأزرار
            document.getElementById("logoutBtn").addEventListener("click", logoutAdmin);
            document.getElementById("saveToGitHub").addEventListener("click", saveDataToGitHub);
            
            // إعداد تغيير نوع الاختبار
            document.getElementById("testType").addEventListener("change", updateTestFormFields);
            
            // إعداد أحداث المودال
            setupModalEvents();
        });

        // ========== الدوال الرئيسية ==========
        async function fetchStudentData() {
            try {
                const response = await fetch(FILE_PATH);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                studentsData = await response.json();
                return studentsData;
            } catch (error) {
                console.error("Error fetching data:", error);
                // جرب جلب البيانات من GitHub إذا فشل جلب الملف المحلي
                return fetchDataFromGitHub();
            }
        }

        async function fetchDataFromGitHub() {
            if (!GITHUB_TOKEN || !GITHUB_REPO || !GITHUB_USER) {
                console.error('GitHub credentials not set');
                return { students: [] };
            }

            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${FILE_PATH}`);
                if (!response.ok) throw new Error('Failed to fetch from GitHub');
                
                studentsData = await response.json();
                return studentsData;
            } catch (error) {
                console.error("Error fetching from GitHub:", error);
                return { students: [] };
            }
        }

        async function loadAdminData() {
            try {
                const data = await fetchStudentData();
                const students = data.students;
                
                // عرض الإحصائيات
                updateStatistics(students);
                
                // تحميل قائمة الطلاب
                loadStudentsList(students);
                
                // تحميل قائمة الاختبارات
                loadTestsLists(students);
                
                // تحديث قائمة الطلاب في التقارير
                updateReportStudentsList(students);
                
            } catch (error) {
                console.error("Error loading data:", error);
                alert("حدث خطأ في تحميل البيانات. يرجى المحاولة لاحقاً.");
            }
        }

        function updateStatistics(students) {
            document.getElementById("totalStudents").textContent = students.length;
            document.getElementById("advancedStudents").textContent = students.filter(s => s.level === "متقدم").length;
            
            const totalTests = students.reduce((total, student) => {
                return total + 
                       (student.quranTests?.length || 0) + 
                       (student.tajweedTests?.length || 0) + 
                       (student.lessonTests?.length || 0);
            }, 0);
            document.getElementById("monthlyTests").textContent = totalTests;
            
            const avgProgress = students.reduce((sum, student) => sum + (student.progress || 0), 0) / students.length;
            document.getElementById("avgProgress").textContent = `${Math.round(avgProgress)}%`;
        }

        function setupAdminNavigation() {
            const navLinks = document.querySelectorAll(".admin-nav a[data-section]");
            
            navLinks.forEach(link => {
                link.addEventListener("click", function(e) {
                    e.preventDefault();
                    
                    // إزالة النشط من جميع الروابط
                    navLinks.forEach(l => l.classList.remove("active"));
                    
                    // إضافة النشط للرابط المحدد
                    this.classList.add("active");
                    
                    // إخفاء جميع الأقسام
                    document.querySelectorAll(".admin-section").forEach(section => {
                        section.classList.remove("active");
                    });
                    
                    // عرض القسم المحدد
                    const sectionId = this.getAttribute("data-section");
                    document.getElementById(sectionId).classList.add("active");
                });
            });
        }

        function setupAdminForms() {
            // نموذج إضافة طالب
            document.getElementById("addStudentForm").addEventListener("submit", function(e) {
                e.preventDefault();
                
                const studentData = {
                    name: document.getElementById("studentName").value,
                    id: document.getElementById("studentId").value,
                    level: document.getElementById("studentLevel").value,
                    image: document.getElementById("studentImage").value || "default.jpg",
                    progress: 0,
                    quranTests: [],
                    tajweedTests: [],
                    lessonTests: []
                };
                
                // إضافة الطالب إلى البيانات
                studentsData.students.push(studentData);
                
                // حفظ البيانات
                saveData();
                
                alert("تمت إضافة الطالب بنجاح!");
                this.reset();
                
                // إعادة تحميل البيانات
                loadAdminData();
            });
            
            // نموذج إضافة اختبار
            document.getElementById("addTestForm").addEventListener("submit", function(e) {
                e.preventDefault();
                
                const testType = document.getElementById("testType").value;
                const studentId = document.getElementById("testStudent").value;
                let testData = {};
                
                if (testType === "quran") {
                    testData = {
                        part: document.getElementById("quranPart").value,
                        memorization: document.getElementById("memorizationScore").value + "%",
                        recitation: document.getElementById("recitationScore").value + "%",
                        date: document.getElementById("testDate").value,
                        details: {
                            notes: document.getElementById("testNotes").value
                        }
                    };
                } else if (testType === "tajweed") {
                    testData = {
                        test: document.getElementById("tajweedTest").value,
                        result: document.getElementById("tajweedScore").value + "%",
                        evaluation: document.getElementById("tajweedEvaluation").value,
                        date: document.getElementById("testDate").value
                    };
                } else {
                    testData = {
                        lesson: document.getElementById("lessonName").value,
                        result: document.getElementById("lessonScore").value + "%",
                        evaluation: document.getElementById("lessonEvaluation").value,
                        date: document.getElementById("testDate").value
                    };
                }
                
                // إضافة الاختبار للطالب
                const student = studentsData.students.find(s => s.id === studentId);
                if (student) {
                    if (testType === "quran") {
                        if (!student.quranTests) student.quranTests = [];
                        student.quranTests.push(testData);
                    } else if (testType === "tajweed") {
                        if (!student.tajweedTests) student.tajweedTests = [];
                        student.tajweedTests.push(testData);
                    } else {
                        if (!student.lessonTests) student.lessonTests = [];
                        student.lessonTests.push(testData);
                    }
                }
                
                // حفظ البيانات
                saveData();
                
                alert("تمت إضافة الاختبار بنجاح!");
                this.reset();
                
                // إعادة تحميل البيانات
                loadAdminData();
            });
            
            // نموذج تعديل الطالب
            document.getElementById("editStudentForm").addEventListener("submit", function(e) {
                e.preventDefault();
                
                const studentId = document.getElementById("editStudentId").value;
                const student = studentsData.students.find(s => s.id === studentId);
                
                if (student) {
                    student.name = document.getElementById("editStudentName").value;
                    student.level = document.getElementById("editStudentLevel").value;
                    student.image = document.getElementById("editStudentImage").value;
                    student.progress = parseInt(document.getElementById("editStudentProgress").value);
                    
                    // حفظ البيانات
                    saveData();
                    
                    alert("تم تحديث بيانات الطالب بنجاح!");
                    closeModal('editStudentModal');
                    loadAdminData();
                }
            });
            
            // زر حذف الطالب
            document.getElementById("deleteStudentBtn").addEventListener("click", function() {
                if (confirm("هل أنت متأكد من حذف هذا الطالب؟ لا يمكن التراجع عن هذه العملية.")) {
                    const studentId = document.getElementById("editStudentId").value;
                    
                    // حذف الطالب من البيانات
                    studentsData.students = studentsData.students.filter(s => s.id !== studentId);
                    
                    // حفظ البيانات
                    saveData();
                    
                    alert("تم حذف الطالب بنجاح!");
                    closeModal('editStudentModal');
                    loadAdminData();
                }
            });
            
            // زر إنشاء التقرير
            document.getElementById("generateReport").addEventListener("click", function() {
                const studentId = document.getElementById("reportStudent").value;
                const reportType = document.getElementById("reportType").value;
                
                // هنا سيتم إنشاء التقرير
                console.log(`إنشاء تقرير ${reportType} للطالب ${studentId || "جميع الطلاب"}`);
                
                // عرض معاينة التقرير
                showReportPreview(studentId, reportType);
            });
        }

        function setupModalEvents() {
            // إغلاق المودال عند النقر على X
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                });
            });
            
            // إغلاق المودال عند النقر خارج المحتوى
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // إعداد نموذج تعديل الاختبار
            document.getElementById("editTestForm").addEventListener("submit", function(e) {
                e.preventDefault();
                
                const testType = document.getElementById("editTestType").value;
                const testId = document.getElementById("editTestId").value;
                const studentId = document.getElementById("editTestStudentId").value;
                
                const student = studentsData.students.find(s => s.id === studentId);
                if (!student) return;
                
                let testArray, testIndex;
                
                if (testType === "quran") {
                    testArray = student.quranTests;
                    testIndex = testArray.findIndex(t => t.part === testId);
                    
                    if (testIndex !== -1) {
                        testArray[testIndex].part = document.getElementById("editQuranPart").value;
                        testArray[testIndex].memorization = document.getElementById("editMemorizationScore").value + "%";
                        testArray[testIndex].recitation = document.getElementById("editRecitationScore").value + "%";
                        testArray[testIndex].date = document.getElementById("editTestDate").value;
                        testArray[testIndex].details.notes = document.getElementById("editTestNotes").value;
                    }
                } else if (testType === "tajweed") {
                    testArray = student.tajweedTests;
                    testIndex = testArray.findIndex(t => t.test === testId);
                    
                    if (testIndex !== -1) {
                        testArray[testIndex].test = document.getElementById("editTajweedTest").value;
                        testArray[testIndex].result = document.getElementById("editTajweedScore").value + "%";
                        testArray[testIndex].evaluation = document.getElementById("editTajweedEvaluation").value;
                        testArray[testIndex].date = document.getElementById("editTestDate").value;
                    }
                } else {
                    testArray = student.lessonTests;
                    testIndex = testArray.findIndex(t => t.lesson === testId);
                    
                    if (testIndex !== -1) {
                        testArray[testIndex].lesson = document.getElementById("editLessonName").value;
                        testArray[testIndex].result = document.getElementById("editLessonScore").value + "%";
                        testArray[testIndex].evaluation = document.getElementById("editLessonEvaluation").value;
                        testArray[testIndex].date = document.getElementById("editTestDate").value;
                    }
                }
                
                // حفظ البيانات
                saveData();
                
                alert("تم تحديث بيانات الاختبار بنجاح!");
                closeModal('editTestModal');
                loadAdminData();
            });
            
            // زر حذف الاختبار
            document.getElementById("deleteTestBtn").addEventListener("click", function() {
                if (confirm("هل أنت متأكد من حذف هذا الاختبار؟ لا يمكن التراجع عن هذه العملية.")) {
                    const testType = document.getElementById("editTestType").value;
                    const testId = document.getElementById("editTestId").value;
                    const studentId = document.getElementById("editTestStudentId").value;
                    
                    const student = studentsData.students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    if (testType === "quran") {
                        student.quranTests = student.quranTests.filter(t => t.part !== testId);
                    } else if (testType === "tajweed") {
                        student.tajweedTests = student.tajweedTests.filter(t => t.test !== testId);
                    } else {
                        student.lessonTests = student.lessonTests.filter(t => t.lesson !== testId);
                    }
                    
                    // حفظ البيانات
                    saveData();
                    
                    alert("تم حذف الاختبار بنجاح!");
                    closeModal('editTestModal');
                    loadAdminData();
                }
            });
        }

        function updateTestFormFields() {
            const testType = document.getElementById("testType").value;
            const container = document.getElementById("testDetailsContainer");
            
            let html = '';
            
            // حقول مشتركة
            html += `
                <div class="form-group">
                    <label for="testStudent">الطالب</label>
                    <select id="testStudent" class="form-control" required>
                        <option value="">اختر الطالب</option>
            `;
            
            // ملء خيارات الطلاب
            studentsData.students.forEach(student => {
                html += `<option value="${student.id}">${student.name}</option>`;
            });
            
            html += `</select></div>`;
            
            // حقول التاريخ
            html += `
                <div class="form-group">
                    <label for="testDate">تاريخ الاختبار</label>
                    <input type="date" id="testDate" class="form-control" required>
                </div>
            `;
            
            // حقول خاصة بنوع الاختبار
            if (testType === "quran") {
                html += `
                    <div class="form-group">
                        <label for="quranPart">جزء القرآن</label>
                        <input type="text" id="quranPart" class="form-control" placeholder="مثال: جزء عم" required>
                    </div>
                    <div class="form-group">
                        <label for="memorizationScore">درجة الحفظ (0-100)</label>
                        <input type="number" id="memorizationScore" class="form-control" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="recitationScore">درجة التلاوة (0-100)</label>
                        <input type="number" id="recitationScore" class="form-control" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="testNotes">ملاحظات المعلم</label>
                        <textarea id="testNotes" class="form-control" rows="3"></textarea>
                    </div>
                `;
            } else if (testType === "tajweed") {
                html += `
                    <div class="form-group">
                        <label for="tajweedTest">اسم اختبار التجويد</label>
                        <input type="text" id="tajweedTest" class="form-control" placeholder="مثال: أحكام النون الساكنة" required>
                    </div>
                    <div class="form-group">
                        <label for="tajweedScore">النتيجة (0-100)</label>
                        <input type="number" id="tajweedScore" class="form-control" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="tajweedEvaluation">تقييم الأداء</label>
                        <textarea id="tajweedEvaluation" class="form-control" rows="3" required></textarea>
                    </div>
                `;
            } else {
                html += `
                    <div class="form-group">
                        <label for="lessonName">اسم الدرس</label>
                        <input type="text" id="lessonName" class="form-control" placeholder="مثال: أحكام المدود" required>
                    </div>
                    <div class="form-group">
                        <label for="lessonScore">النتيجة (0-100)</label>
                        <input type="number" id="lessonScore" class="form-control" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="lessonEvaluation">تقييم الأداء</label>
                        <textarea id="lessonEvaluation" class="form-control" rows="3" required></textarea>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function loadStudentsList(students) {
            const tbody = document.getElementById("studentsList");
            tbody.innerHTML = "";
            
            students.forEach((student, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${student.image}" alt="${student.name}" width="40" height="40" style="border-radius:50%"></td>
                    <td>${student.name}</td>
                    <td>${student.id}</td>
                    <td>${student.level}</td>
                    <td>
                        <div class="progress-bar" style="width:100%; height:10px; background:#eee">
                            <div style="width:${student.progress}%; height:100%; background:var(--primary-color)"></div>
                        </div>
                        <small>${student.progress}%</small>
                    </td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm edit-student" data-id="${student.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm delete-student" data-id="${student.id}"><i class="fas fa-trash"></i></button>
                        <button class="btn btn-primary btn-sm view-student" data-id="${student.id}"><i class="fas fa-eye"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // إضافة أحداث لأزرار التعديل والحذف
            document.querySelectorAll('.edit-student').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    openEditStudentModal(studentId);
                });
            });
            
            document.querySelectorAll('.delete-student').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    if (confirm(`هل أنت متأكد من حذف الطالب رقم ${studentId}؟`)) {
                        deleteStudent(studentId);
                    }
                });
            });
        }

        function loadTestsLists(students) {
            // تجميع جميع الاختبارات
            let quranTests = [];
            let tajweedTests = [];
            let lessonTests = [];
            
            students.forEach(student => {
                // اختبارات القرآن
                if (student.quranTests) {
                    student.quranTests.forEach(test => {
                        quranTests.push({
                            ...test,
                            studentName: student.name,
                            studentId: student.id
                        });
                    });
                }
                
                // اختبارات التجويد
                if (student.tajweedTests) {
                    student.tajweedTests.forEach(test => {
                        tajweedTests.push({
                            ...test,
                            studentName: student.name,
                            studentId: student.id
                        });
                    });
                }
                
                // اختبارات الدروس
                if (student.lessonTests) {
                    student.lessonTests.forEach(test => {
                        lessonTests.push({
                            ...test,
                            studentName: student.name,
                            studentId: student.id
                        });
                    });
                }
            });
            
            // ملء اختبارات القرآن
            const quranTbody = document.getElementById("quranTestsList");
            quranTbody.innerHTML = "";
            quranTests.forEach(test => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${test.part}</td>
                    <td><span class="score-badge ${getScoreClass(parseInt(test.memorization))}">${test.memorization}</span></td>
                    <td><span class="score-badge ${getScoreClass(parseInt(test.recitation))}">${test.recitation}</span></td>
                    <td>${test.date}</td>
                    <td>${test.studentName}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm edit-test" data-type="quran" data-id="${test.part}" data-student="${test.studentId}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm delete-test" data-type="quran" data-id="${test.part}" data-student="${test.studentId}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                quranTbody.appendChild(row);
            });
            
            // ملء اختبارات التجويد
            const tajweedTbody = document.getElementById("tajweedTestsList");
            tajweedTbody.innerHTML = "";
            tajweedTests.forEach(test => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${test.test}</td>
                    <td><span class="score-badge ${getScoreClass(parseInt(test.result))}">${test.result}</span></td>
                    <td>${test.evaluation}</td>
                    <td>${test.date}</td>
                    <td>${test.studentName}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm edit-test" data-type="tajweed" data-id="${test.test}" data-student="${test.studentId}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm delete-test" data-type="tajweed" data-id="${test.test}" data-student="${test.studentId}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tajweedTbody.appendChild(row);
            });
            
            // ملء اختبارات الدروس
            const lessonTbody = document.getElementById("lessonTestsList");
            lessonTbody.innerHTML = "";
            lessonTests.forEach(test => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${test.lesson}</td>
                    <td><span class="score-badge ${getScoreClass(parseInt(test.result))}">${test.result}</span></td>
                    <td>${test.evaluation}</td>
                    <td>${test.date}</td>
                    <td>${test.studentName}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm edit-test" data-type="lesson" data-id="${test.lesson}" data-student="${test.studentId}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm delete-test" data-type="lesson" data-id="${test.lesson}" data-student="${test.studentId}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                lessonTbody.appendChild(row);
            });
            
            // إضافة أحداث لأزرار التعديل والحذف للاختبارات
            document.querySelectorAll('.edit-test').forEach(btn => {
                btn.addEventListener('click', function() {
                    const testType = this.getAttribute('data-type');
                    const testId = this.getAttribute('data-id');
                    const studentId = this.getAttribute('data-student');
                    openEditTestModal(testType, testId, studentId);
                });
            });
            
            document.querySelectorAll('.delete-test').forEach(btn => {
                btn.addEventListener('click', function() {
                    const testType = this.getAttribute('data-type');
                    const testId = this.getAttribute('data-id');
                    const studentId = this.getAttribute('data-student');
                    
                    if (confirm(`هل أنت متأكد من حذف هذا الاختبار؟`)) {
                        deleteTest(testType, testId, studentId);
                    }
                });
            });
        }

        function updateReportStudentsList(students) {
            const reportSelect = document.getElementById("reportStudent");
            reportSelect.innerHTML = '<option value="">جميع الطلاب</option>';
            students.forEach(student => {
                const option = document.createElement("option");
                option.value = student.id;
                option.textContent = student.name;
                reportSelect.appendChild(option);
            });
        }

        function showReportPreview(studentId, reportType) {
            const preview = document.getElementById("reportPreview");
            
            if (reportType === "progress") {
                preview.innerHTML = `
                    <div class="card">
                        <h4>تقرير التقدم الدراسي</h4>
                        ${studentId ? `<p>لطالب معين</p>` : `<p>لجميع الطلاب</p>`}
                        <div id="progressChart"></div>
                        <p>سيتم هنا عرض رسم بياني يوضح تقدم الطالب/الطلاب</p>
                    </div>
                `;
            } else if (reportType === "tests") {
                preview.innerHTML = `
                    <div class="card">
                        <h4>تقرير الاختبارات</h4>
                        ${studentId ? `<p>لطالب معين</p>` : `<p>لجميع الطلاب</p>`}
                        <div id="testsChart"></div>
                        <p>سيتم هنا عرض جدول يلخص نتائج الاختبارات</p>
                    </div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="card">
                        <h4>تقرير الأداء العام</h4>
                        ${studentId ? `<p>لطالب معين</p>` : `<p>لجميع الطلاب</p>`}
                        <div id="performanceChart"></div>
                        <p>سيتم هنا عرض تحليل شامل لأداء الطالب/الطلاب</p>
                    </div>
                `;
            }
        }

        function openEditStudentModal(studentId) {
            const student = studentsData.students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById("editStudentId").value = student.id;
            document.getElementById("editStudentName").value = student.name;
            document.getElementById("editStudentLevel").value = student.level;
            document.getElementById("editStudentImage").value = student.image;
            document.getElementById("editStudentProgress").value = student.progress;
            
            document.getElementById("editStudentModal").style.display = "block";
        }

        function openEditTestModal(testType, testId, studentId) {
            const student = studentsData.students.find(s => s.id === studentId);
            if (!student) return;
            
            let test, testArray;
            
            if (testType === "quran") {
                testArray = student.quranTests;
                test = testArray.find(t => t.part === testId);
            } else if (testType === "tajweed") {
                testArray = student.tajweedTests;
                test = testArray.find(t => t.test === testId);
            } else {
                testArray = student.lessonTests;
                test = testArray.find(t => t.lesson === testId);
            }
            
            if (!test) return;
            
            document.getElementById("editTestType").value = testType;
            document.getElementById("editTestId").value = testId;
            document.getElementById("editTestStudentId").value = studentId;
            
            let html = '';
            
            if (testType === "quran") {
                html = `
                    <div class="form-group">
                        <label for="editQuranPart">جزء القرآن</label>
                        <input type="text" id="editQuranPart" class="form-control" value="${test.part}" required>
                    </div>
                    <div class="form-group">
                        <label for="editMemorizationScore">درجة الحفظ (0-100)</label>
                        <input type="number" id="editMemorizationScore" class="form-control" 
                               value="${parseInt(test.memorization)}" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="editRecitationScore">درجة التلاوة (0-100)</label>
                        <input type="number" id="editRecitationScore" class="form-control" 
                               value="${parseInt(test.recitation)}" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="editTestDate">تاريخ الاختبار</label>
                        <input type="date" id="editTestDate" class="form-control" value="${test.date}" required>
                    </div>
                    <div class="form-group">
                        <label for="editTestNotes">ملاحظات المعلم</label>
                        <textarea id="editTestNotes" class="form-control" rows="3">${test.details?.notes || ''}</textarea>
                    </div>
                `;
            } else if (testType === "tajweed") {
                html = `
                    <div class="form-group">
                        <label for="editTajweedTest">اسم اختبار التجويد</label>
                        <input type="text" id="editTajweedTest" class="form-control" value="${test.test}" required>
                    </div>
                    <div class="form-group">
                        <label for="editTajweedScore">النتيجة (0-100)</label>
                        <input type="number" id="editTajweedScore" class="form-control" 
                               value="${parseInt(test.result)}" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="editTajweedEvaluation">تقييم الأداء</label>
                        <textarea id="editTajweedEvaluation" class="form-control" rows="3" required>${test.evaluation}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTestDate">تاريخ الاختبار</label>
                        <input type="date" id="editTestDate" class="form-control" value="${test.date}" required>
                    </div>
                `;
            } else {
                html = `
                    <div class="form-group">
                        <label for="editLessonName">اسم الدرس</label>
                        <input type="text" id="editLessonName" class="form-control" value="${test.lesson}" required>
                    </div>
                    <div class="form-group">
                        <label for="editLessonScore">النتيجة (0-100)</label>
                        <input type="number" id="editLessonScore" class="form-control" 
                               value="${parseInt(test.result)}" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="editLessonEvaluation">تقييم الأداء</label>
                        <textarea id="editLessonEvaluation" class="form-control" rows="3" required>${test.evaluation}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTestDate">تاريخ الاختبار</label>
                        <input type="date" id="editTestDate" class="form-control" value="${test.date}" required>
                    </div>
                `;
            }
            
            document.getElementById("editTestFields").innerHTML = html;
            document.getElementById("editTestModal").style.display = "block";
        }

        function deleteStudent(studentId) {
            studentsData.students = studentsData.students.filter(s => s.id !== studentId);
            saveData();
            alert("تم حذف الطالب بنجاح!");
            loadAdminData();
        }

        function deleteTest(testType, testId, studentId) {
            const student = studentsData.students.find(s => s.id === studentId);
            if (!student) return;
            
            if (testType === "quran") {
                student.quranTests = student.quranTests.filter(t => t.part !== testId);
            } else if (testType === "tajweed") {
                student.tajweedTests = student.tajweedTests.filter(t => t.test !== testId);
            } else {
                student.lessonTests = student.lessonTests.filter(t => t.lesson !== testId);
            }
            
            saveData();
            alert("تم حذف الاختبار بنجاح!");
            loadAdminData();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        function getScoreClass(score) {
            if (score >= 90) return "excellent";
            if (score >= 80) return "very-good";
            if (score >= 70) return "good";
            return "weak";
        }

        async function saveDataToGitHub() {
            if (!GITHUB_TOKEN || !GITHUB_REPO || !GITHUB_USER) {
                alert('لم يتم تعيين بيانات GitHub. لا يمكن الحفظ.');
                return;
            }

            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = 'جاري الحفظ...';
            statusElement.style.color = 'var(--info-color)';

            try {
                // أولاً: احصل على SHA الحالي للملف
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const fileInfo = await getResponse.json();
                const sha = fileInfo.sha;
                
                // ثانياً: قم بتحديث الملف
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(studentsData, null, 2)));
                const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'تم تحديث بيانات الطلاب من لوحة التحكم',
                        content: content,
                        sha: sha
                    })
                });
                
                const result = await updateResponse.json();
                console.log('File updated:', result);
                statusElement.textContent = 'تم الحفظ بنجاح على GitHub';
                statusElement.style.color = 'var(--success-color)';
                
                // جلب أحدث نسخة من البيانات بعد الحفظ
                setTimeout(() => {
                    loadAdminData();
                    statusElement.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error saving to GitHub:', error);
                statusElement.textContent = 'حدث خطأ أثناء الحفظ على GitHub';
                statusElement.style.color = 'var(--danger-color)';
            }
        }

        function saveData() {
            // حفظ محلي للبيانات
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            // محاولة الحفظ على GitHub إذا كانت البيانات متاحة
            if (GITHUB_TOKEN && GITHUB_REPO && GITHUB_USER) {
                saveDataToGitHub();
            }
        }

        function logoutAdmin() {
            localStorage.removeItem("adminToken");
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
